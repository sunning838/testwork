<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>다운로드 템플릿(PDF 출력 및 다운로드) - 웹사이트 스타일</title>
    <style>
        /* 1. 기본 및 배경 스타일 */
        body {
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%); 
            color: #343a40;
            margin: 0;
            /* 수정: body 여백 및 높이 조정 */
            padding: 40px; 
            min-height: 100vh;
            box-sizing: border-box; /* padding이 너비/높이에 포함되도록 */
        }

        /* --- 2. 2단 레이아웃 래퍼 --- */
        .app-wrapper {
            display: flex;
            flex-direction: row; /* 가로 정렬 */
            justify-content: center;
            align-items: flex-start;
            gap: 20px; /* 두 요소 사이의 간격 */
            width: 100%;
        }

        /* 3. 메인 컨테이너 스타일 (왼쪽 UI) */
        .container {
            background-color: #ffffff;
            padding: 30px; 
            border-radius: 16px; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(0, 0, 0, 0.05);
            width: 90%;
            /* 수정: 초기 UI 최대 너비 대폭 확장 */
            max-width: 800px; 
            text-align: center;
            transition: transform 0.3s ease; 
            flex-shrink: 0; 
        }
        .container:hover {
            transform: translateY(-3px);
        }

        /* 4. 이미지 스타일 */
        .container img {
            max-width: 500px;
            height: auto;
            margin-bottom: 10px; 
            display: block;
            margin-left: auto;
            margin-right: auto;
            border-radius: 24px;
        }

        /* 5. 헤더 스타일 */
        h1 {
            color: #1f2937;
            margin-bottom: 8px;
            font-size: 1.6em; 
            font-weight: 700;
        }

        .subtitle {
            color: #6b7280;
            margin-bottom: 25px; 
            font-size: 0.9em;
        }

        /* 6. 입력 그룹 및 드래그 앤 드롭 영역 */
        .input-group {
            margin: 0 auto 20px auto; 
            width: 100%;
            max-width: 740px; 
            text-align: left;
            padding: 22.5px;
            min-height: 100px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            transition: border-color 0.2s ease-in-out;
            cursor: pointer;
        }
        .input-group.highlight {
            border-color: #4f46e5;
            background-color: #f0f4ff;
        }
        .input-group label {
            font-weight: 500;
            color: #4b5563;
            display: block;
            margin-bottom: 5px;
        }

        input[type="file"] {
            margin-top: 0;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            background-color: #f9fafb;
            cursor: pointer;
        }
        
        /* 7. PDF 뷰어 스타일 (오른쪽 영역) */
       #pdfViewerContainer {
            display: none; 
            flex-grow: 1; 
            width: 100%;
            height: 90vh; 
            
            /* Modern UI 스타일 적용 */
            background-color: #ffffff;
            padding: 30px; /* .container와 동일한 패딩 */
            border-radius: 16px; 
            /* .container와 동일한 그림자 */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(0, 0, 0, 0.05);
            box-sizing: border-box; /* 패딩 포함 크기 계산 */
        }
        #pdfViewer {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* 8. 버튼 스타일 (기존 변환 시작 버튼) */
        .controls {
            margin: 0 auto 30px auto;
            width: 100%;
            max-width: 760px; 
        }
        .controls button {
            padding: 18px 20px;
            font-size: 20px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            transition: background-color 0.2s ease-in-out, transform 0.1s;
            width: 100%;
            font-weight: 600;
        }
        #startButton {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
        }
        #startButton:hover:not(:disabled) {
            background-color: #4338ca;
            transform: translateY(-1px);
        }
        .controls button:disabled {
            background-color: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        /* 9. 로딩 스피너 CSS */
        #spinnerContainer {
            display: none;
            margin: 30px auto;
            min-height: 50px; 
            justify-content: center;
            align-items: center;
        }
        .loader {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 10. 상태 메시지 영역 */
        #statusMessageElement {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px; 
            font-weight: 500;
            text-align: center;
            border: 1px solid #d1d5db;
            min-height: 20px;
            /* 수정: 너비 확장 */
            max-width: 740px;
            margin: 15px auto 0 auto;
        }
        
        /* 11. 새로운 변환 시작 버튼 (왼쪽 UI 하단으로 이동) */
        #resetButton {
            display: none; 
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            transition: background-color 0.2s ease-in-out;
            width: 100%;
            font-weight: 600;
            background-color: #10b981;
            color: white;
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2);
            /* 수정: 너비 확장 */
            max-width: 740px;
            margin: 20px auto 0 auto;
        }
        #resetButton:hover {
            background-color: #059669;
        }

        /* 상태별 색상 */
        .status-success {
            background-color: #d1fae5; 
            color: #065f46;
            border-color: #a7f3d0;
        }
        .status-error {
            background-color: #fee2e2; 
            color: #991b1b;
            border-color: #fecaca;
        }
        /* 수정: 색상 복원 (이전 요청 반영) */
        .status-info {
            background-color: #cce5ff; 
            color: #004085;
            border-color: #b8daff;
        }
    </style>
</head>

<body>

    <div class="app-wrapper">

        <div class="container">
            <img src="drummer.png" alt="드럼 치는 사람">
            <h1>드럼 사운드 자동 분류 및 악보 생성 시스템</h1>
            <p class="subtitle">파일 전송 후 로딩 완료시 다운로드가 시작됩니다.</p>

            <div class="input-group">
                <label for="fileInput">파일을 드래그하거나 선택:</label>
                <input type="file" id="fileInput" name="file" accept="audio/*">
            </div>

            <div class="controls">
                <button id="startButton" onclick="startProcess()">변환 시작</button>
            </div>

            <div id="spinnerContainer">
                <div class="loader"></div>
            </div>
            
            <div id="statusMessageElement" class="status-info">파일을 선택하거나 드래그하여 올려주세요.</div>

            <button id="resetButton" onclick="resetUI()">새로운 변환 시작</button>
        </div>

        <div id="pdfViewerContainer">
            <iframe id="pdfViewer" title="PDF Viewer"></iframe>
        </div>
        
    </div>

    <script>
        // --- 1. 전역 변수 설정 ---
        const API_URL = 'http://127.0.0.1:5000/api/download_midi'; 
        const PDF_API_URL = 'http://127.0.0.1:5000/api/get_pdf_content'; 
        const VIRTUAL_WAIT_SECONDS = 5; 

        let isProcessing = false;
        let midiBlob = null;
        let pdfBlob = null; 
        let downloadFilename = ''; 

        // --- 2. DOM 요소 설정 ---
        const fileInput = document.getElementById('fileInput');
        const startButton = document.getElementById('startButton');
        const statusMessageElement = document.getElementById('statusMessageElement');
        const spinnerContainer = document.getElementById('spinnerContainer');
        const inputGroup = document.querySelector('.input-group');
        const pdfViewerContainer = document.getElementById('pdfViewerContainer');
        const pdfViewer = document.getElementById('pdfViewer');
        const resetButton = document.getElementById('resetButton'); 


        // --- 3. 상태 메시지 업데이트 헬퍼 함수 ---
        function updateStatus(message, type = 'info') {
            statusMessageElement.innerText = message;
            statusMessageElement.className = `status-${type}`;
        }

        // --- 4. 드래그 앤 드롭 이벤트 핸들러 (유지) ---
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            inputGroup.addEventListener(eventName, preventDefaults, false);
        });
        ['dragenter', 'dragover'].forEach(eventName => {
            inputGroup.addEventListener(eventName, () => inputGroup.classList.add('highlight'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            inputGroup.addEventListener(eventName, () => inputGroup.classList.remove('highlight'), false);
        });
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        inputGroup.addEventListener('drop', handleDrop, false);
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            fileInput.files = files; 
            handleFileSelect();
        }
        
        // --- 5. 파일 선택 변경 감지 리스너 (기존 로직 시작점) ---
        fileInput.addEventListener('change', handleFileSelect);

        function handleFileSelect() {
            const selectedFile = fileInput.files[0];
            
            if (selectedFile) {
                updateStatus(`파일 '${selectedFile.name}'이 선택되었습니다. 변환 시작을 눌러주세요.`, 'info');
                // 기존 PDF 뷰어 숨김 (초기화)
                pdfViewerContainer.style.display = 'none';
                resetButton.style.display = 'none';
            } else {
                resetUI();
            }
        }


        // --- 6. 서버 통신 함수 (미디 및 PDF) ---
        // (이전 코드와 동일)

        // 미디 파일 다운로드 요청
        function sendForMidiDownload(file) {
            updateStatus(`[1/3] 파일 변환 을 위해 파일을 전송 중...`, 'info'); 
            const formData = new FormData();
            formData.append('file', file);

            return fetch(API_URL, { method: 'POST', body: formData })
                .then(response => {
                    if (!response.ok) {
                         return response.json().then(err => { throw new Error(`MIDI 오류: ${err.error || response.status}`); });
                    }
                    
                    const disposition = response.headers.get('Content-Disposition') || response.headers.get('content-disposition');
                    const filenameMatch = disposition ? disposition.split('filename=')[1] : null;
                    const filename = filenameMatch ? filenameMatch.replace(/\"/g, '') : downloadFilename; 

                    return response.blob().then(blob => ({ blob, filename }));
                });
        }
        
        // PDF 파일 내용 요청 (출력용)
        function fetchPdfForDisplay(file) {
            updateStatus(`[2/3] 악보 파일을 요청 중...`, 'info');
            const formData = new FormData();
            formData.append('file', file); 

            return fetch(PDF_API_URL, { method: 'POST', body: formData })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`악보 요청 실패: [HTTP ${response.status}]`);
                }
                return response.blob(); 
            });
        }

        // --- 7. 완료 후 다운로드 및 출력 실행 (Phase 3) ---
        function finalizeActions(midiBlob, pdfBlob, midiFilename) {
            
            // 1. 미디 파일 다운로드 실행
            updateStatus(`✅ 파일 생성 완료! 다운로드를 시작합니다.`, 'success'); 
            
            const midiUrl = window.URL.createObjectURL(midiBlob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = midiUrl;
            a.download = midiFilename; 
            document.body.appendChild(a);
            a.click(); // 미디 파일 다운로드 시작
            window.URL.revokeObjectURL(midiUrl);

            // 2. PDF 화면 출력
            updateStatus(`✅ 파일 생성 완료! 다운로드를 시작합니다.`, 'success');

            const pdfUrl = window.URL.createObjectURL(pdfBlob);
            pdfViewer.src = pdfUrl;
            
            // --- UI 변경 (오른쪽에 뷰어 표시) ---
            pdfViewerContainer.style.display = 'block'; 
            resetButton.style.display = 'block'; 

            // 3. UI 정리 (왼쪽 UI)
            spinnerContainer.style.display = 'none';
            inputGroup.style.display = 'none'; 
            startButton.style.display = 'none';
        }


        // --- 8. 전체 프로세스 시작 (버튼 클릭 시) ---
        function startProcess() {
            if (isProcessing) return;

            const selectedFile = fileInput.files[0];

            if (!selectedFile) {
                alert('파일을 먼저 선택해주세요.');
                return;
            }

            // 파일명 시뮬레이션: 미디 파일명만 예측
            let originalName = selectedFile.name;
            let baseName = originalName.lastIndexOf('.') > 0 ? originalName.substring(0, originalName.lastIndexOf('.')) : originalName;
            downloadFilename = baseName + '.midi'; 

            isProcessing = true;
            startButton.disabled = true;
            startButton.innerText = '전송 중...';
            
            // UI 숨김 및 스피너 표시 (왼쪽 UI)
            inputGroup.style.display = 'none'; 
            startButton.style.display = 'none'; 
            pdfViewerContainer.style.display = 'none'; 
            resetButton.style.display = 'none';
            spinnerContainer.style.display = 'flex';
            
            let currentMidiBlob;
            
            // 1단계: 미디 파일 요청 (메인 다운로드)
            sendForMidiDownload(selectedFile)
                .then(midiResult => {
                    currentMidiBlob = midiResult.blob;
                    downloadFilename = midiResult.filename; // 서버에서 받은 미디 파일명 확정

                    // 2단계: PDF 파일 요청 (출력용)
                    return fetchPdfForDisplay(selectedFile); 
                })
                .then(pdfResultBlob => {
                    pdfBlob = pdfResultBlob;

                    updateStatus(`서버 응답 확인! 최종 처리 중...`, 'info');

                    // 3단계: 가상 로딩 시간(5초) 대기 후 최종 동작 실행
                    setTimeout(() => {
                        finalizeActions(currentMidiBlob, pdfBlob, downloadFilename);
                    }, VIRTUAL_WAIT_SECONDS * 1000); 
                })
                .catch(error => {
                    console.error('전체 프로세스 중 오류:', error);
                    updateStatus(`❌ 처리 실패: ${error.message}`, 'error');
                    resetUI();
                });
        }

        // --- 9. UI 초기화 ---
        function resetUI() {
            isProcessing = false;

            startButton.disabled = false;
            startButton.innerText = `변환 시작`;
            startButton.style.display = 'block'; // 버튼 표시

            spinnerContainer.style.display = 'none';
            pdfViewerContainer.style.display = 'none';
            resetButton.style.display = 'none';

            inputGroup.style.display = 'block'; // 입력 필드 표시

            fileInput.value = null; 
            
            // Blob URL 해제
            if (pdfViewer.src) {
                URL.revokeObjectURL(pdfViewer.src);
                pdfViewer.src = '';
            }

            midiBlob = null;
            pdfBlob = null;
            downloadFilename = '';

            updateStatus("파일을 선택하거나 드래그하여 올려주세요.", 'info');
        }

        document.addEventListener('DOMContentLoaded', resetUI);
    </script>
</body>

</html>